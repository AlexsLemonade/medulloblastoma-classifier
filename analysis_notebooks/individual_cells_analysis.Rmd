---
title: "scRNA-seq: Individual cells analysis"
author: "Steven Foltz and Jaclyn Taroni"
date: "2024"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    df_print: paged
---

This notebook uses pair-based medulloblastoma subgroup prediction models trained on bulk data to predict the subgroup of individual cells in scRNA-seq samples.
k-Top Scoring Pairs (kTSP) and random forest (RF) models were trained using bulk gene expression data (bulk array and RNA-seq) in `analysis_notebooks/baseline_models.Rmd`.
Here, we analyze the kTSP and RF predictions on individual cells generated in `predict/predict_pseudobulk_and_single_cells.R`.

We are using scRNA-seq data associated with the following publications:

- [Hovestadt, et al.](https://www.nature.com/articles/s41586-019-1434-6), which is Smart-seq2 dataset
- [Riemondy, et al.](https://doi.org/10.1093/neuonc/noab135), which is a 10X Genomics dataset

# Setup

Set seed.

```{r setup}
set.seed(8222)
```

Set MB subgroups.

```{r}
mb_subgroups <- c("G3", "G4", "SHH", "WNT")
```

## Libraries and functions

```{r}
# Load libraries 
source(here::here("utils/color_schemes.R"))
library(patchwork)
```

## Directories and files

```{r}
processed_data_dir <- here::here("processed_data")
plots_dir <- here::here("plots")
plots_data_dir <- here::here(plots_dir, "data")

# Individual cell predictions plot data
plot_data_filepath <- here::here(plots_data_dir, 
                                 "single_cell_test_predictions.tsv")
```

## Read in data

```{r}
single_cell_plot_df <- readr::read_tsv(plot_data_filepath,
                                       show_col_types = FALSE)
```


```{r}
# To find the second highest score, we need the number of subgroups (columns)
# minus 1
second_highest_index <- length(mb_subgroups) - 1
single_cell_plot_df <- single_cell_plot_df |>
  # For each row
  dplyr::rowwise() |>
  # Add a column that is the difference between the max score and the second
  # highest score
  # https://stackoverflow.com/questions/2453326/fastest-way-to-find-second-third-highest-lowest-value-in-vector-or-column
  dplyr::mutate(
    max_score_diff = max - sort(c(G3, G4, SHH, WNT), partial = second_highest_index)[second_highest_index]
  ) |>
  dplyr::ungroup()
```

```{r}
smartseq_object <- single_cell_plot_df |>
  dplyr::filter(study == "GSE119926") |>
  dplyr::count(sample_accession, subgroup, predicted_labels, model_type) |>
  ggplot2::ggplot(ggplot2::aes(y = sample_accession,
                               x = n,
                               fill = predicted_labels)) +
  ggplot2::geom_col(position = ggplot2::position_fill()) +
  ggplot2::scale_x_continuous(labels = scales::percent) + # percentage makes sense here
  ggplot2::facet_grid(rows = ggplot2::vars(subgroup),
                      cols = ggplot2::vars(model_type),
                      space = "free_y",
                      scales = "free_y") +
  ggplot2::scale_fill_manual(values = subgroup_colors) +
  ggplot2::labs(y = NULL,
                x = "Single-cell Percentage",
                fill = "Predicted Subgroup",
                title = "GSE119926 (Smart-seq2)") +
  ggplot2::theme_bw() +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, 
                                                     vjust = 1,
                                                     hjust = 1),
                 plot.title = ggplot2::element_text(hjust = 0.5))

tenx_object <- single_cell_plot_df |>
  dplyr::filter(study == "GSE155446") |>
  dplyr::count(sample_accession, subgroup, predicted_labels, model_type) |>
  ggplot2::ggplot(ggplot2::aes(y = sample_accession,
                               x = n,
                               fill = predicted_labels)) +
  ggplot2::geom_col(position = ggplot2::position_fill()) +
  ggplot2::scale_x_continuous(labels = scales::percent) + # percentage makes sense here
  ggplot2::facet_grid(rows = ggplot2::vars(subgroup),
                      cols = ggplot2::vars(model_type),
                      space = "free_y",
                      scales = "free_y") +
  ggplot2::scale_fill_manual(values = subgroup_colors) +
  ggplot2::labs(y = NULL,
                x = "Single-cell Percentage",
                fill = "Predicted Subgroup",
                title = "GSE155446 (10x)") +
  ggplot2::theme_bw() +
  ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 45, 
                                                     vjust = 1,
                                                     hjust = 1),
                 plot.title = ggplot2::element_text(hjust = 0.5))

smartseq_object + tenx_object + plot_layout(guides = "collect")
```

```{r}
smartseq_max_diff_object <- single_cell_plot_df |>
  dplyr::filter(study == "GSE119926") |>
  ggplot2::ggplot(
    ggplot2::aes(x = predicted_labels,
                 y = max_score_diff,
                 group = predicted_labels,
                 color = predicted_labels)
  ) +
  ggplot2::geom_violin() +
  ggplot2::scale_color_manual(values = subgroup_colors, guide = "none") +
  ggplot2::stat_summary(fun = "median", geom = "point") +
  ggplot2::labs(x = "Cell Predicted Subgroup",
                y = "Max Score - Second Highest Score",
                title = "GSE119926 (Smart-seq2)") +
  ggplot2::facet_grid(rows = ggplot2::vars(model_type),
                      cols = ggplot2::vars(subgroup)) +
  ggplot2::theme_bw() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5),
                 axis.text.x = ggplot2::element_text(angle = 45, 
                                                     vjust = 1,
                                                     hjust = 1))

tenx_max_diff_object <- single_cell_plot_df |>
  dplyr::filter(study == "GSE155446") |>
  ggplot2::ggplot(
    ggplot2::aes(x = predicted_labels,
                 y = max_score_diff,
                 group = predicted_labels,
                 color = predicted_labels)
  ) +
  ggplot2::geom_violin() +
  ggplot2::scale_color_manual(values = subgroup_colors, guide = "none") +
  ggplot2::stat_summary(fun = "median", geom = "point") +
  ggplot2::labs(x = "Cell Predicted Subgroup",
                y = "Max Score - Second Highest Score",
                title = "GSE155446 (10x)") +
  ggplot2::facet_grid(rows = ggplot2::vars(model_type),
                      cols = ggplot2::vars(subgroup)) +
  ggplot2::theme_bw() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5),
                 axis.text.x = ggplot2::element_text(angle = 45, 
                                                     vjust = 1,
                                                     hjust = 1))

smartseq_max_diff_object + tenx_max_diff_object
```

# Session Info

```{r}
sessionInfo()
```

