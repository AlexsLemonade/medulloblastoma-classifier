---
title: "Plot AUCell scores for Hovestadt et al. G3/G4 metaprograms"
author: "Jaclyn Taroni"
date: "2025"
output:
  html_document:
    toc: TRUE
    toc_float: TRUE
    df_print: paged
---

The purpose of this notebook is to visualize and analyze AUCell scores for the G3/G4 metaprograms introduced in [Hovestadt et al. 2019.](https://www.nature.com/articles/s41586-019-1434-6)
These scores are calculated via `scripts/calculate_metaprogram_aucell.R`.
Briefly, the 100 genes that are included in Table S2 from Hovestadt et al. 2019. are used as input to `AUCell`. 
AUCell scores measure the proportion of genes in a gene set that are highly expressed (i.e., ranked in the top 5% of genes) in a cell.

## Setup

### Libraries

```{r message=FALSE}
library(ggplot2)
library(patchwork)
```

### Directories and files

```{r}
plots_data_dir <- here::here("plots/data")
results_dir <- here::here("results")

# Individual cell predictions
smartseq_predictions_file <- here::here(
  plots_data_dir,
  "smartseq_single_cell_test_predictions.tsv"
)
tenx_predictions_file <- here::here(
  plots_data_dir,
  "10x_single_cell_test_predictions.tsv"
)

# AUCell scores
smartseq_aucell_file <- here::here(
  results_dir,
  "GSE119926_hovestadt-et-al-group-3-4-metaprogram_aucell-scores.tsv"
)
tenx_aucell_file <- here::here(
  results_dir, 
  "GSE155446_hovestadt-et-al-group-3-4-metaprogram_aucell-scores.tsv"
)
```

### Source

We need the color schemes.

```{r}
source(here::here("utils/color_schemes.R"))
```

## Read in and set up data

```{r}
# Read in predicted labels, UMAP coords, etc.
smartseq_pred_df <- readr::read_tsv(smartseq_predictions_file,
                                    show_col_types = FALSE,
                                    progress = FALSE)
tenx_pred_df <- readr::read_tsv(tenx_predictions_file,
                                    show_col_types = FALSE,
                                    progress = FALSE)

# Read in AUCell scores
smartseq_auc_df <- readr::read_tsv(smartseq_aucell_file,
                                    show_col_types = FALSE,
                                    progress = FALSE)
tenx_auc_df <- readr::read_tsv(tenx_aucell_file,
                                    show_col_types = FALSE,
                                    progress = FALSE)

# Add AUCell scores to predicted labels, UMAP coords, etc.
smartseq_df <- smartseq_pred_df |>
  dplyr::left_join(smartseq_auc_df, 
                   by = c("sample_accession", "cell_index"))
tenx_df <- tenx_pred_df |>
  dplyr::left_join(tenx_auc_df, 
                   by = c("sample_accession", "cell_index"))

# Remove data frames that were joined
rm(smartseq_auc_df, smartseq_pred_df, tenx_auc_df, tenx_pred_df)
```

## Can we reproduce the Hovestadt et al. results with AUCell?

Based on the results in [Hovestadt et al. 2019.](https://www.nature.com/articles/s41586-019-1434-6), we would expect cells that are from G3 samples to have high expression of the Group 3/4-B program and cells from G4 samples to have high expression of the Group 3/4-C program.
At the very least, we should be able to reproduce this finding in the Hovestadt et al. dataset.
Ideally, we will find that this pattern generalizes to the 10X dataset from [Riemondy et al. 2021](https://doi.org/10.1093/neuonc/noab135).

We will plot the AUCell scores broken up by `subgroup`, which is the *true* label.

```{r}
# Smart-seq2 dataset from Hovestadt et al.
smartseq_subgroup_plot <- smartseq_df |>
  # Don't want repeat values coming from including both model types
  dplyr::filter(model_type == "kTSP (unw)") |>
  # Pivot longer to allow for faceting by metaprogram
  dplyr::select(sample_accession,
                cell_index,
                subgroup,
                dplyr::starts_with("Group")) |>
  tidyr::pivot_longer(cols = dplyr::starts_with("Group"),
                      names_to = "metaprogram") |>
  ggplot(
    aes(
      x = subgroup,
      y = value
    )
  ) + 
  geom_violin() +
  stat_summary(fun = median, geom = "point") + 
  theme_bw() +
  facet_grid(cols = vars(metaprogram)) +
  labs(
    x = "True Sample Subgroup",
    y = "AUCell Score",
    title = "GSE119926 (Smart-seq2)"
  )

# 10X dataset from Riemondy et al.
tenx_subgroup_plot <- tenx_df |>
  # Don't want repeat values coming from including both model types
  dplyr::filter(model_type == "kTSP (unw)") |>
  # Pivot longer to allow for faceting by metaprogram
  dplyr::select(sample_accession,
                cell_index,
                subgroup,
                dplyr::starts_with("Group")) |>
  tidyr::pivot_longer(cols = dplyr::starts_with("Group"),
                      names_to = "metaprogram") |>
  ggplot(
    aes(
      x = subgroup,
      y = value
    )
  ) + 
  geom_violin() +
  stat_summary(fun = median, geom = "point") + 
  theme_bw() +
  facet_grid(cols = vars(metaprogram)) +
  labs(
    x = "True Sample Subgroup",
    y = "AUCell Score",
    title = "GSE155446 (10X)"
  )

# Show panels
smartseq_subgroup_plot / tenx_subgroup_plot
```

We see the expected pattern in the Smart-seq2 dataset.
We see the expected pattern for the Group 3/4-C metaprogram in the 10X dataset as well.
The results for the Group 3/4-B metaprogram are less clear cut -- it seems plausible that the sparsity of the 10X dataset comes into play here.

## Predicted labels

If our classifier picks up on similar patterns as the metaprograms, we would expect the predicted labels to show a similar pattern to the true subgroup labels.
Naively, this is what we might expect, as we know that individual cell labels typically match the true subgroup label for a sample.

```{r}
smartseq_predicted_label_plot <- smartseq_df |>
  # Don't want repeat values coming from including both model types
  dplyr::filter(model_type == "kTSP (unw)") |>
  # Pivot longer to allow for faceting by metaprogram
  dplyr::select(sample_accession,
                cell_index,
                predicted_labels,
                dplyr::starts_with("Group")) |>
  tidyr::pivot_longer(cols = dplyr::starts_with("Group"),
                      names_to = "metaprogram") |>
  ggplot(
    aes(
      x = predicted_labels,
      y = value
    )
  ) + 
  geom_violin() +
  stat_summary(fun = median, geom = "point") + 
  theme_bw() +
  facet_grid(cols = vars(metaprogram)) +
  labs(
    x = "Predicted Label",
    y = "AUCell Score",
    title = "GSE119926 (Smart-seq2)"
  ) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# 10X dataset from Riemondy et al.
tenx_predicted_label_plot <- tenx_df |>
  # Don't want repeat values coming from including both model types
  dplyr::filter(model_type == "kTSP (unw)") |>
  # Put unclassified last
  dplyr::mutate(predicted_labels = factor(predicted_labels,
                                          levels = names(subgroup_colors))) |>
  # Pivot longer to allow for faceting by metaprogram
  dplyr::select(sample_accession,
                cell_index,
                predicted_labels,
                dplyr::starts_with("Group")) |>
  tidyr::pivot_longer(cols = dplyr::starts_with("Group"),
                      names_to = "metaprogram") |>
  ggplot(
    aes(
      x = predicted_labels,
      y = value
    )
  ) + 
  geom_violin() +
  stat_summary(fun = median, geom = "point") + 
  theme_bw() +
  facet_grid(cols = vars(metaprogram)) +
  labs(
    x = "Predicted Label",
    y = "AUCell Score",
    title = "GSE155446 (10X)"
  ) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Show panels
smartseq_predicted_label_plot / tenx_predicted_label_plot
```

The predicted labels generally show the same trend as the true subgroup labels:

- G3-labeled cells have higher Group 3/4-B metaprogram scores than G4-labeled cells in the Hovestadt et al. dataset, but we also see higher scores in SHH- and WNT-labeled cells.
- This difference in Group 3/4-B scores is less clear cut in the Riemondy et al. (10X) dataset.
- Both datasets show that G4-labeled cells have higher scores for the Group 3/4-C metaprogram.

## Session Info

```{r}
sessionInfo()
```

